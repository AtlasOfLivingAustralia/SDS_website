---
title: "Make a highlighted time series"
description: |
  Time series comparisons can be handy for seeing trends in data. Here, we explore how to look at some stuff about ducks   
author:
  - name: "Thai Rushbrook"
  - name: "Olivia Torresan"
  - name: "Dax Kellie"
date: "2022-03-07"
title-block-banner: "#B8573E"
toc: true
toc-location: left
toc-depth: 3
categories:
  - Eukaryota
  - Animalia
  - Aves
  - Summaries
  - Intern-post
image: choropleth_ggnewscale.png
freeze: true
draft: true
---

```{r}
#| include: false
library(htmltools)
```

<!-- remove metadata section -->
```{css, echo = FALSE}
#title-block-header.quarto-title-block.default .quarto-title-meta {
    display: none;
}
```


<!-- Author card -->

:::{.author-card}
:::{.author-card-text}

#### Author
Thai Rushbrook  
[Olivia Torresan](https://labs.ala.org.au/people/Torresan_Olivia/index.html)  
[Dax Kellie](https://labs.ala.org.au/people/Kellie_Dax/index.html)  

#### Date
7 March 2023

:::

:::{.author-card-image}
```{r, out.width='120px', out.extra='style="clip-path: circle();"', echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/thai.jpg")
```
:::

:::{.author-card-image}
```{r, out.width='120px', out.extra='style="clip-path: circle();"', echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/olivia.jpg")
```
:::

:::{.author-card-image}
```{r, out.width='120px', out.extra='style="clip-path: circle();"', echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/dax.jpg")
```
:::

:::

<!------------------------ Post starts here ------------------------>

Thanks to huge efforts by citizen scientists, a majority of species observations in the Atlas of Living Australia are collected opportunistically, where people record observations incidentally rather than through a recurring monitoring program.

However, whether an observation is recorded or not doesn't just depend on the species. It might be rainy, it might be too hot, an area might be inaccessible; all of these factors can affect whether people make an observation.

The COVID-19 pandemic had a major impact on people's health, behaviour and travel. In Australia, several lockdowns over 2020-2021 imposed restrictions on people's movements, limiting them to either stay at home or choose activities (mainly exercise) that they could do in their local area. Melbourne experienced [the longest continuous lockdown in the world](https://www.9news.com.au/national/coronavirus-update-victoria-monday-october-4-melbournes-lockdown-longest-world/e159d5b5-2d0f-452a-adb3-979150f9793f). 

To what extent did COVID-19 and lockdowns affect the number of species observations people made over that time? Here, we'll use a highlighted time-series plot to investigate how lockdowns affected the data collection of *Anatidae* observations (ducks, geese and swans), a group frequently recorded on walks and outdoor gatherings, in Melbourne compared to previous years.

# Get data

We'll start by downloading *Anatidae* records.

:::{layout-ncol=3 style="width=120px;"}

<img class = "clipped" src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/5/9/2/0/cd4a660e-358c-4863-81b8-08cfd7280295/original"></img>

<img class = "clipped"src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/7/c/4/2/b133aa0c-ba9f-4f19-8f2f-938f34b724c7/original"></img>

<img class = "clipped" src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/1/c/9/e/f35fbe9d-1116-4eb2-82d4-03d8e032e9c1/original"></img>

:::
::: {.figure-caption}
Left: [*Tadorna (Casarca) tadornoides* (Tracey Hinton CC-BY-NC 4.0 (Int))](https://biocache.ala.org.au/occurrences/31f020c4-1050-40e7-b499-8cf89afa84fe) Middle: [*Cygnus (Chenopis) atratus* (jpshahady CC-BY-NC 4.0 (Int))](https://biocache.ala.org.au/occurrences/2af3958b-1a06-45a7-8ee2-315c63c2f0c6) Right: [*Spatula rhynchotis* (Annette Green CC-BY-NC 4.0 (Int))](https://biocache.ala.org.au/occurrences/546765db-4567-479d-b78f-77433493fae6)
:::

First, let's load some packages: 

```{r}
#| message: false
#| warning: false
#| error: false
# Load packages
library(galah)
library(tidyverse)
library(lubridate)
library(grid)
library(ggplot2)
library(pilot) # remotes::install_github("olihawkins/pilot")
library(ggtext)
library(showtext)
```

Let's use the [{galah} package]() to download duck records in Melbourne from 2017-2021 to get records from years just before and during COVID-19 lockdowns. 

Searching with `galah::search_fields()` shows us that {galah} contains Greater Capital City Statistical Areas, which we can use to filter our query. 

```{r}
search_all(fields, "city")
search_all(fields, "city") |> search_values("melbourne")
```


Let's build our query to return *Anatidae* records from `GREATER MELBOURNE` from 2017 to 2021. We'll use `galah_select()` to return only the `eventDate` column.

You will need to first provide a [registered email with the ALA](https://auth.ala.org.au/userdetails/registration/createAccount) using `galah_config()` before retrieving records.

```{r}
#| eval: false
# Add registered email (register at ala.org.au)
galah_config(email = "your-email@email.com")
```

```{r}
#| echo: false
#| message: false
#| warning: false
galah_config(email = "dax.kellie@csiro.au", verbose = FALSE)
```

```{r}
#| message: false
ducks <-
  galah_call() |>
  galah_identify("Anatidae") |>
  galah_filter(
    cl10929 == "GREATER MELBOURNE",
    # year >= 2017,
    # year <= 2021,
    eventDate >= "2017-01-01T00:00:00Z",
    eventDate <= "2021-12-31T23:59:00Z",
    basisOfRecord == "HUMAN_OBSERVATION"
  ) |>
  galah_select(eventDate) |>
  atlas_occurrences()

ducks |> head(6L)
```

We'll pull out some week and year of each date and count the total occurrence records for each week.

```{r}
#| message: false
#| warning: false
ducks_weekly <- ducks |> 
  mutate(date = as_date(eventDate),
         year = year(eventDate),
         week = week(eventDate)) |>
  group_by(year, week) |>
  summarise(week_count = n())

ducks_weekly 
```

We are intending to compare record counts in 2020-2021 to previous years. However, because record numbers added to the ALA have grown each year, it's likely that comparing raw numbers will show a biased view that there were more records than previous years.

To avoid this, let's *scale* our record counts by the total number of *Anatidae* records each year so that we compare proportions rather than raw numbers. 

First let's download the total *Anatidae* records for each year. 

```{r}
ducks_yearly <- 
  galah_call() |>    
  galah_identify("Anatidae") |> 
  galah_filter(cl10929 == "GREATER MELBOURNE", 
               year >= 2017, year <= 2021) |> 
  galah_group_by(year) |>
  atlas_counts() |>
  rename(year_total = count) |>
  mutate(year = as.numeric(year)) |>
  arrange(-desc(year))
  
ducks_yearly
```

Now we'll split `ducks_weekly` into 5 `data.frame`s for each year and divide the record count by the total for each year with `map2()`. At the end we'll bind the separate `data.frame`s into one again with `bind_rows()`.

```{r}
ducks_scaled <- ducks_weekly %>%
  split(.$year) %>%
  map2(.x = .,
       .y = ducks_yearly$year_total, 
       ~ .x %>%
         mutate(prop = .x$week_count / .y) %>%
         select(-week_count)
  ) %>%
  bind_rows()

ducks_scaled
```

In our final plot we want to compare the "normal" number of records collected prior to COVID-19 to the number collected in 2020 and 2021. It would be nice to show the average "normal" number as one line. With that goal in mind, let's calculate the mean proportion of records each week from 2017-2019.

To do this, we'll place our weekly proportions in separate columns with `pivot_wider()` and calculate the mean proportion of observations over 2017-2019.

```{r}
ducks_scaled <- ducks_scaled %>%
  pivot_wider(names_from = year, 
              values_from = prop, 
              names_sort = TRUE,
              names_glue = "year_{year}") |>
  rowwise() |>
  mutate(
    mean_2017_19 = mean(c_across(year_2017:year_2019))
    ) |>
  select(-year_2017, -year_2018, -year_2019)

ducks_scaled
```

Now that we have our dataset, it needs a bit of reorganising to make it suitable for plotting. Counts are grouped by week of the year, meaning we have 2 sets of weeks 1-52 (one for 2020, one for 2021). To plot these in order along an axis we need to convert this to 1-53 for 2020 (a leap year, extra week), then 54-106 for 2021.

```{r}
# 2021 record count proportions
ducks_scaled_2021 <- ducks_scaled |>
  rename(prop = year_2021) |>
  mutate(week = 53 + week)

# 2020 + 2021 record count proportions
ducks_final <- ducks_scaled |>
  rename(prop = year_2020) |>
  bind_rows(ducks_scaled_2021)

ducks_final
```


# Lockdowns

During the height of the pandemic, Melbourne had 6 distinct lockdowns. Let's add their start and end dates to a `tibble`.

Because we want to plot 2020 and 2021 on the same plot, we'll use `ifelse()` to add 54 to weeks in 202 so that our week numbers extend from the beginning of 2020 to the end of 2021.

```{r}
#| message: false
n_lockdown <- c(1:6)
start_date <- c("2020-03-31", "2020-07-09",
                "2021-02-13", "2021-05-28",
                "2021-07-16", "2021-08-05")
end_date <- c("2020-05-12", "2020-10-27",
              "2021-02-17", "2021-06-10",
              "2021-07-27", "2021-10-21")

lockdowns <- tibble(n_lockdown, start_date, end_date) |>
  mutate(
    n_days = as_date(ymd(end_date)) - as_date(ymd(start_date)),
    week_start = ifelse(year(start_date) == 2020, 
                        week(start_date), week(start_date) + 54),
    week_end = ifelse(year(end_date) == 2020, 
                      week(end_date), week(end_date) + 54),
    )
lockdowns 
```


# Make plot

## Step 3: Plot!

To help us see the components of our final plot more clealy, let's construct our visualisation step-by-step.

First, add our lockdown dates as highlighted rectangular blocks. To do this we can use `geom_rect()` and set `xmin` and `xmax` values to our `week_start` and `week_end` columns in `lockdowns`. We'll make the rectangle spread across the entire plot by setting `ymax = Inf` and `ymin = 0`.

Setting our `fill` inside of `aes()` and defining its value within `scale_fill_manual()` allows us to add the yellow highlighted colour to its own legend, which will be useful later. 

```{r}
#| column: body-outset
#| fig-align: center
p1 <- ggplot() +
  geom_rect(data = lockdowns,
            aes(xmin = week_start,
                xmax = week_end,
                fill = "Lockdown"),
            ymin = 0,
            ymax = Inf,
            alpha=0.2) +
  scale_fill_manual(
    values = c("Lockdown" = pilot_color("yellow")))
p1
```

Next we'll add our species observation counts as lines. We'll also define their colours and edit the legend and axis labels. 

The plot created after these steps is enough to see everything we need to see about our data. You *could* stop here if you wished, especially if you were only making this plot for yourself.

```{r}
#| warning: false
#| column: body-outset
#| fig-align: center
p2 <- p1 +
  # add lines
  geom_line(data = ducks_final, 
            aes(x = week, y = prop, 
            color = "2020-21 Records"), 
            linewidth = 1) + 
  geom_line(data = ducks_final, 
            aes(x = week, y = mean_2017_19, 
            color = "2017-19 Average"),
            linetype = "twodash", 
            linewidth = 0.8) + 
  # add fill
  geom_area(data = ducks_final, 
            aes(x = week, y = prop),
            fill=pilot_color("blue"), 
            alpha=0.3) + 
  scale_color_manual(values = c(pilot_color("orange"),
                                pilot_color("blue")), 
                     labels = c("2017-19 (average)", 
                                "2020-21")) +
  guides(fill = guide_legend(title = ""), 
         color = guide_legend(title = "Year")) +
  labs(y = "Proportion of ducks recorded",
       x = "Month",
       title = "Duck, geese & swan observations in Melbourne (2020-21 vs. 2017-19)",
       subtitle = "Weekly ALA records during and prior to COVID-19",
       caption = "Weekly proportions scaled by total records for that year")
p2
```

Here's a more refined visualisation with nice fonts, axis scales, axis labels and titles:

(feel free to use this code for your own plots!)

```{r}
#| column: page
#| fig-align: center
#| fig-width: 10
#| fig-height: 7
#| code-fold: true

# add fonts
font_add_google("Montserrat", family = "mont")
font_add_google("Hind", family = "hind")  
showtext_auto(enable = TRUE)

p2 + 
  # make axis scales understandable
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 0.035),
                     labels = scales::percent_format()) +
  scale_x_continuous(expand = c(0, 0),
                     limits = c(1, 106),
                     breaks = c(1, 14, 27, 40, 53, 66, 79, 92),
                     labels = c("Jan", "Apr", "Jul", "Oct", "Jan", "Apr", "Jul", "Oct")) +
  # add year x axis labels
  coord_cartesian(clip = "off") +
  annotate_pilot(label = "2020", x = 27, y = 0, 
                 alpha = 0.7, vjust = 3.8,size = 10) +
  annotate_pilot(label = "2021", x = 79, y = 0, 
                 alpha = 0.7, vjust = 3.8, size = 10) +
  labs(title = "Duck, geese & swan observations in Melbourne (2020-21 vs. 2017-19)") +
  theme_pilot(grid = "",
              axes = "bl") +
  theme(axis.title.x = element_text(size = 23, vjust = -1.3),
        axis.title.y = element_text(size = 23),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.line = element_line(linewidth = 0.5),
        legend.text = element_text(size = 23),
        legend.title = element_text(size = 20),
        plot.caption = element_text(size = 18),
        text = element_text(family = "hind"),
        plot.title = element_markdown(family = "mont", size = 31),
        plot.subtitle = element_text(family = "mont", size = 28))
```

Now that we have our final plot, we can see a few interesting trends: 

  1. Species observations were *lower* than the 2017-2019 average during the first lockdown (soon after COVID-19 arrived in Australia). 
  2. Species observations were *higher* than the 2017-2019 average during the 2 longer lockdowns.
  3. Observations increased in the last half of all lockdowns except the first lockdown.
  
Are these trends that you expected to see? 

It's impossible to make any claims of *why* these trends emerged from our data visualisation alone, but we can speculate (for fun). 

Were people making fewer observations in the first lockdown because they were preoccupied with other priorities as they settled into new working-from-home routines? Did people make more observations at the tail end of lockdowns because they were spending more time by natural ponds and lakes, seeking anxiety relief as they grew weary spending time at home? 

Some evidence from the US found [more people were using natural spaces during COVID-19](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0243344), and [time in these spaces lowered depression and anxiety](https://www.sciencedirect.com/science/article/pii/S1353829222000740). A New Zealand study [found similar results](https://www.mdpi.com/2071-1050/14/12/7308).

# Final thoughts

This post has detailed you can use ALA data to explore relationships between record counts and events. Although we can't make any causal claims from what we see in our plot, it's a nice way to do some exploratory analysis of a lot of data!


<details><summary style = "color: #E06E53;">Expand for session info</summary>

```{r, echo = FALSE}
library(sessioninfo)
# save the session info as an object
pkg_sesh <- session_info(pkgs = "attached")
# print it out
pkg_sesh
```

</details>
