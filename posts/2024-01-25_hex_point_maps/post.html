<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.540">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Callum Waite">
<meta name="author" content="Shandiya Balasubramaniam">
<meta name="dcterms.date" content="2024-01-25">
<meta name="description" content="Visualising multiple species distributions in a single figure can be difficult if there are areas where ranges overlap. In this post we introduce a way to show several species distributions in an area at once using a novel twist on the commonly used hexbin map.">

<title>ALA Labs - Combining multiple species distributions on one map with hexagons and points</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-4355440-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #B8573E;
      }
</style>


<link rel="stylesheet" href="../../theme.css">
<link rel="stylesheet" href="../../custom_theme.scss">
<meta property="og:title" content="ALA Labs - Combining multiple species distributions on one map with hexagons and points">
<meta property="og:description" content="Visualising multiple species distributions in a single figure can be difficult if there are areas where ranges overlap. In this post we introduce a way to show several species distributions in an area at once using a novel twist on the commonly used hexbin map.">
<meta property="og:image" content="https://labs.ala.org.au/posts/2024-01-25_hex_point_maps/map_hexbin-points.png">
<meta property="og:site_name" content="ALA Labs">
<meta property="og:image:height" content="1344">
<meta property="og:image:width" content="1920">
<meta name="twitter:title" content="ALA Labs - Combining multiple species distributions on one map with hexagons and points">
<meta name="twitter:description" content="Visualising multiple species distributions in a single figure can be difficult if there are areas where ranges overlap. In this post we introduce a way to show several species distributions in an area at once using a novel twist on the commonly used hexbin map.">
<meta name="twitter:image" content="https://labs.ala.org.au/posts/2024-01-25_hex_point_maps/map_hexbin-points.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1344">
<meta name="twitter:image-width" content="1920">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/logos/ALA_Logo_Inline_REV-RGB.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ALA Labs</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> <i class="bi bi-house-door-fill" role="img">
</i> 
<span class="menu-text"> </span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts/index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-research" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Research</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-research">    
        <li>
    <a class="dropdown-item" href="../../research/highlights.html">
 <span class="dropdown-text">Highlights</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../research/citations.html">
 <span class="dropdown-text">All citations</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../software/software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.ala.org.au"> <i class="bi bi-ala" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/AtlasOfLivingAustralia/ala-labs"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Combining multiple species distributions on one map with hexagons and points</h1>
                  <div>
        <div class="description">
          <p>Visualising multiple species distributions in a single figure can be difficult if there are areas where ranges overlap. In this post we introduce a way to show several species distributions in an area at once using a novel twist on the commonly used hexbin map.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Eukaryota</div>
                <div class="quarto-category">Animalia</div>
                <div class="quarto-category">Chordata</div>
                <div class="quarto-category">Aves</div>
                <div class="quarto-category">Maps</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Authors</div>
      <div class="quarto-title-meta-contents">
               <p>Callum Waite </p>
               <p>Shandiya Balasubramaniam </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 25, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#download-data" id="toc-download-data" class="nav-link active" data-scroll-target="#download-data">Download data</a></li>
  <li><a href="#generate-hex-grid" id="toc-generate-hex-grid" class="nav-link" data-scroll-target="#generate-hex-grid">Generate hex grid</a>
  <ul class="collapse">
  <li><a href="#remove-empty-hexes" id="toc-remove-empty-hexes" class="nav-link" data-scroll-target="#remove-empty-hexes">Remove empty hexes</a></li>
  <li><a href="#visualising-multiple-species-in-a-hexagon" id="toc-visualising-multiple-species-in-a-hexagon" class="nav-link" data-scroll-target="#visualising-multiple-species-in-a-hexagon">Visualising multiple species in a hexagon</a></li>
  <li><a href="#set-up-7-points" id="toc-set-up-7-points" class="nav-link" data-scroll-target="#set-up-7-points">Set up 7 points</a></li>
  </ul></li>
  <li><a href="#assign-species-to-positions" id="toc-assign-species-to-positions" class="nav-link" data-scroll-target="#assign-species-to-positions">Assign species to positions</a></li>
  <li><a href="#map" id="toc-map" class="nav-link" data-scroll-target="#map">Map</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<!-- remove metadata section -->
<style>
  #title-block-header.quarto-title-block.default .quarto-title-meta {
      display: none;
  }
</style>
<!-- Author card -->
<div class="author-card">
<div class="author-card-text">
<section id="author" class="level4">
<h4 class="anchored" data-anchor-id="author">Author</h4>
<p><a href="https://labs.ala.org.au/about/Waite_Callum/index.html">Callum Waite</a><br>
<a href="https://labs.ala.org.au/about/Balasubramaniam_Shandiya/index.html">Shandiya Balasubramaniam</a></p>
</section>
<section id="date" class="level4">
<h4 class="anchored" data-anchor-id="date">Date</h4>
<p>25 January 2024</p>
</section>
</div>
<div class="author-card-image">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/callum.jpg" class="nolightbox img-fluid figure-img" style="clip-path: circle();" width="120"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="author-card-image">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/shandiya.png" class="nolightbox img-fluid figure-img" style="clip-path: circle();" width="120"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<!------------------------ Post starts here ------------------------>
<p>Visualisations of species distributions can be very simple yet effective ways of conveying biological and ecological information, such as range, habitat, and relative population size.</p>
<p>Representing more than one species distribution in a single figure can be difficult, though, especially where there are areas of overlap. Points and colour-filled polygons will obscure each other even with a degree of transparency, while densities and shaded regions can only show one species at a time.</p>
<p>Here, we demonstrate a method to visualise distributions of multiple species with overlapping ranges on the same map, with only a small loss in resolution. The technique is a novel twist on the commonly used <a href="https://r-graph-gallery.com/hexbin-map.html">hexbin map</a>: instead of using a colour fill to represent presence/absence or counts within each hexagon, we use multiple coloured points within each hexagon to represent presence/absence of species, allowing users to get a broad overview of how multiple species are distributed across an area.</p>
<p>This method requires a number of steps to build up the elements of the final figure:</p>
<ul>
<li>Getting occurrence records for species of interest</li>
<li>Creating a hex grid over the area of occupancy for those species</li>
<li>Assigning locations and colour to each species within each hex</li>
</ul>
<p>The final figure will comprise a combination of the basemap, hex grid, and species points once these elements are created.</p>
<p>Let’s begin by loading the R packages we’ll be using.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(galah)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ozmaps)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(showtext)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll use the <a href="https://galah.ala.org.au">{galah} package</a> to download occurrence records from the <a href="https://www.ala.org.au">Atlas of Living Australia (ALA)</a>. To do this, you’ll need to <a href="https://auth.ala.org.au/userdetails/registration/createAccount">register your email address with the ALA</a>, then pass it to {galah} using <code>galah_config()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">galah_config</span>(<span class="at">email =</span> <span class="st">"your-email@email.com"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="download-data" class="level2">
<h2 class="anchored" data-anchor-id="download-data">Download data</h2>
<p>Since our goal here is to map distributions of multiple species, we’ve chosen honeyeaters from the genus <em>Melithreptus</em>: this is a distinctive group of 7 small- to medium-sized, short-billed and square-tailed honeyeaters with overlapping distributions across Australia.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="3" style="margin-left: auto; margin-right: auto;">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p><img src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/3/a/2/5/323bd0bc-545f-48fa-85aa-eb77dcd052a3/original" class="rounded"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p><img src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/b/7/c/a/d96d11b4-4150-48c2-990a-20b70064ac7b/original" class="rounded"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p><img src="https://ala-images.s3.ap-southeast-2.amazonaws.com/store/6/1/5/2/03f17fd7-a256-44c8-a377-011784ef2516/original" class="rounded"></p>
</div>
</div>
</div>
<div class="figure-caption">
<p>Left: <a href="https://biocache.ala.org.au/occurrences/53209bab-d2c1-4aab-ace7-e2de155389ae"><em>Melithreptus gularis</em> - Black-chinned Honeyeater (Graham Winterflood CC-BY-NC 4.0 (Int))</a>, Middle: <a href="https://biocache.ala.org.au/occurrences/a0792deb-18a9-4e59-9419-add4d7b5d0c9"><em>Melithreptus chloropsis</em> - Gilbert’s Honeyeater (Wacrakey CC-BY-NC 4.0 (Int))</a>, Right: <a href="https://biocache.ala.org.au/occurrences/26edb457-4c80-4073-a6a8-176e68cf431e"><em>Melithreptus validirostris</em> - Strong-billed Honeyeater (Bird Explorers CC-BY-NC 4.0 (Int))</a></p>
</div>
<p>We can get taxonomic information about this group using <code>atlas_species()</code>…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>melithreptus <span class="ot">&lt;-</span> <span class="fu">galah_call</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_identify</span>(<span class="st">"Melithreptus"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">atlas_species</span>()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>melithreptus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 10
  kingdom  phylum   class order         family genus species author species_guid
  &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;         &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;       
1 Animalia Chordata Aves  Passeriformes Melip… Meli… Melith… (Viei… https://bio…
2 Animalia Chordata Aves  Passeriformes Melip… Meli… Melith… (Vigo… https://bio…
3 Animalia Chordata Aves  Passeriformes Melip… Meli… Melith… Gould… https://bio…
4 Animalia Chordata Aves  Passeriformes Melip… Meli… Melith… (Goul… https://bio…
5 Animalia Chordata Aves  Passeriformes Melip… Meli… Melith… (Less… https://bio…
6 Animalia Chordata Aves  Passeriformes Melip… Meli… Melith… (Goul… https://bio…
7 Animalia Chordata Aves  Passeriformes Melip… Meli… Melith… Gould… https://bio…
# ℹ 1 more variable: vernacular_name &lt;chr&gt;</code></pre>
</div>
</div>
<p>… and then use this information to download occurrence records for the 7 species. We’ll apply a general set of ALA data quality filters to remove low quality records with <code>galah_apply_profile()</code>, and pass in the list of species we’re interested in with <code>galah_identify()</code>. We’ll also filter records to 2022<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, choosing only those with spatial coordinates and that fall within one of the <a href="https://www.dcceew.gov.au/environment/land/nrs/science/ibra">IBRA bioregions</a> (as a proxy for Australian records only).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>species_occ <span class="ot">&lt;-</span> <span class="fu">galah_call</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_apply_profile</span>(ALA) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_identify</span>(melithreptus<span class="sc">$</span>species) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_filter</span>(year <span class="sc">==</span> <span class="dv">2022</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>               <span class="sc">!</span><span class="fu">is.na</span>(cl1048),  <span class="co"># IBRA bioregions</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>               <span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>               <span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude)) <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">galah_select</span>(decimalLatitude,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>               decimalLongitude,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>               species, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>               scientificName) <span class="sc">|&gt;</span> </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">atlas_occurrences</span>()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(species_occ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  decimalLatitude decimalLongitude species                    scientificName    
            &lt;dbl&gt;            &lt;dbl&gt; &lt;chr&gt;                      &lt;chr&gt;             
1           -43.6             147. Melithreptus validirostris Melithreptus (Eid…
2           -43.6             147. Melithreptus validirostris Melithreptus (Eid…
3           -43.5             146. Melithreptus validirostris Melithreptus (Eid…
4           -43.5             147. Melithreptus affinis       Melithreptus (Mel…
5           -43.5             147. Melithreptus affinis       Melithreptus (Mel…
6           -43.5             147. Melithreptus validirostris Melithreptus (Eid…</code></pre>
</div>
</div>
<p>Since we’re going to be performing a few spatial operations to assign species to hexagons, let’s convert the <code>species_occ</code> dataframe into a simple features (<code>sf</code>) object, with latitude and longitude columns represented as points in a geometry column named <code>occ_geometry</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>species_occ_sf <span class="ot">&lt;-</span> species_occ <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span>), </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_geometry</span>(<span class="st">"occ_geometry"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(species_occ_sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 146.1362 ymin: -43.59761 xmax: 147.1435 ymax: -43.48602
Geodetic CRS:  WGS 84
# A tibble: 6 × 3
  species                    scientificName                    occ_geometry
  &lt;chr&gt;                      &lt;chr&gt;                              &lt;POINT [°]&gt;
1 Melithreptus validirostris Melithreptus (Eidopsarus… (146.8627 -43.59761)
2 Melithreptus validirostris Melithreptus (Eidopsarus… (146.8627 -43.59761)
3 Melithreptus validirostris Melithreptus (Eidopsarus… (146.1362 -43.50299)
4 Melithreptus affinis       Melithreptus (Melithrept… (147.1435 -43.49038)
5 Melithreptus affinis       Melithreptus (Melithrept… (146.9424 -43.48602)
6 Melithreptus validirostris Melithreptus (Eidopsarus… (146.9424 -43.48602)</code></pre>
</div>
</div>
</section>
<section id="generate-hex-grid" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="generate-hex-grid">Generate hex grid</h2>
<p>Next, we’ll set up a grid of hexagons across Australia, which we’ll use as bins for plotting summaries of species occurrence.</p>
<p><code>st_make_grid()</code> can make a grid that covers the bounding box of the supplied shapefile (here the <code>ozmap_country</code> shapefile), with arguments for specifying the size, type, and orientation of polygons in a grid. We’ll transform the projection to match the coordinate reference system we set for the species occurrence records above (<code>4326</code>), and assign a unique identifier to each hexagon in a column named <code>hex_id</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(ozmap_country,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cellsize =</span> <span class="dv">2</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">what =</span> <span class="st">"polygons"</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">square =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">flat_topped =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_geometry</span>(<span class="st">"hex_geometry"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowid_to_column</span>(<span class="at">var =</span> <span class="st">"hex_id"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>hex_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 703 features and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 104.396 ymin: -45.63203 xmax: 170.7912 ymax: -7.632027
Geodetic CRS:  WGS 84
First 10 features:
   hex_id                   hex_geometry
1       1 POLYGON ((106.128 -44.63203...
2       2 POLYGON ((109.5921 -44.6320...
3       3 POLYGON ((113.0562 -44.6320...
4       4 POLYGON ((116.5203 -44.6320...
5       5 POLYGON ((119.9844 -44.6320...
6       6 POLYGON ((123.4485 -44.6320...
7       7 POLYGON ((126.9126 -44.6320...
8       8 POLYGON ((130.3767 -44.6320...
9       9 POLYGON ((133.8408 -44.6320...
10     10 POLYGON ((137.3049 -44.6320...</code></pre>
</div>
</div>
<p>Our grid of hexagons looks like this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ozmap_states, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">"darkgrey"</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">linewidth =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> hex_grid, </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> <span class="st">"deepskyblue4"</span>, </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">linewidth =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="post_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="post_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<section id="remove-empty-hexes" class="level3">
<h3 class="anchored" data-anchor-id="remove-empty-hexes">Remove empty hexes</h3>
<p>You’ve probably noticed there are a lot of redundant hexagons in the grid we just created. Not every terrestrial hexagon will contain an occurrence record, and we can confidently assume hexagons in the ocean will not contain records of honeyeaters.</p>
<p>We’ll remove these empty hexagons with a spatial join (which behaves similarly to <code>dplyr::left_join()</code> for spatial objects). This returns a dataframe that has all the information from our original occurrence download, where each row is a record of a species in a particular location, but each record’s point location has now been matched to a hexagon from the grid we just created.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>hex_with_species <span class="ot">&lt;-</span> <span class="fu">st_join</span>(<span class="at">x =</span> hex_grid, </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">y =</span> species_occ_sf,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">join =</span> st_intersects,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">left =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hex_with_species, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 10 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 145.9652 ymin: -44.63203 xmax: 148.2746 ymax: -42.63203
Geodetic CRS:  WGS 84
     hex_id                    species                          scientificName
32       32 Melithreptus validirostris Melithreptus (Eidopsarus) validirostris
32.1     32 Melithreptus validirostris Melithreptus (Eidopsarus) validirostris
32.2     32 Melithreptus validirostris Melithreptus (Eidopsarus) validirostris
32.3     32       Melithreptus affinis     Melithreptus (Melithreptus) affinis
32.4     32       Melithreptus affinis     Melithreptus (Melithreptus) affinis
32.5     32 Melithreptus validirostris Melithreptus (Eidopsarus) validirostris
32.6     32 Melithreptus validirostris Melithreptus (Eidopsarus) validirostris
32.7     32 Melithreptus validirostris Melithreptus (Eidopsarus) validirostris
32.8     32 Melithreptus validirostris Melithreptus (Eidopsarus) validirostris
32.9     32       Melithreptus affinis     Melithreptus (Melithreptus) affinis
                       hex_geometry
32   POLYGON ((145.9652 -43.6320...
32.1 POLYGON ((145.9652 -43.6320...
32.2 POLYGON ((145.9652 -43.6320...
32.3 POLYGON ((145.9652 -43.6320...
32.4 POLYGON ((145.9652 -43.6320...
32.5 POLYGON ((145.9652 -43.6320...
32.6 POLYGON ((145.9652 -43.6320...
32.7 POLYGON ((145.9652 -43.6320...
32.8 POLYGON ((145.9652 -43.6320...
32.9 POLYGON ((145.9652 -43.6320...</code></pre>
</div>
</div>
<p>This means any hexagons we initially created in the grid that don’t intersect with occurrence records have been removed:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ozmap_states, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">colour =</span> <span class="st">"darkgrey"</span>, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">linewidth =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">count</span>(hex_with_species, hex_id, hex_geometry), </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> <span class="st">"deepskyblue4"</span>, </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="post_files/figure-html/unnamed-chunk-15-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="post_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualising-multiple-species-in-a-hexagon" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="visualising-multiple-species-in-a-hexagon">Visualising multiple species in a hexagon</h3>
<p>As some hexagons will contain occurrence records for more than one species, we need a way to display these overlaps. We’ll do this by setting up 7 positions in each hexagon, 1 for each species, and assign each species a position and colour so they can be visually differentiated.</p>
<p>The figure below summarises the process we’ll follow: for each hexagon remaining in the grid, we’ll generate a smaller hexagon, then get the coordinates of each vertex and centroid of the smaller hexagon. This gives us 7 positions to display up to 7 species in each hexagon.</p>
<div data-layout-align="center" class="page-columns page-full">
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="post_files/figure-html/unnamed-chunk-17-1.png" class="lightbox page-columns page-full" data-description="Steps

to

build

a

grid

of

points

inside

each

hexagon" data-gallery="hex"><img src="post_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img column-page" style="margin-left:auto;margin-right:auto;" width="960"></a></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="set-up-7-points" class="level3">
<h3 class="anchored" data-anchor-id="set-up-7-points">Set up 7 points</h3>
<p>Let’s start by extracting the unique identifiers and spatial coordinates for every hexagon containing an occurrence record<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Each <code>hex_id</code> refers to one of the remaining hexagons in our grid. This is step 1 from the figure above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>unique_hex <span class="ot">&lt;-</span> hex_with_species <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(hex_id, hex_geometry) <span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">n</span><span class="st">`</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>unique_hex</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 157 features and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 113.0562 ymin: -44.63203 xmax: 155.2028 ymax: -9.632027
Geodetic CRS:  WGS 84
First 10 features:
   hex_id                   hex_geometry
1      32 POLYGON ((145.9652 -43.6320...
2      50 POLYGON ((144.2331 -42.6320...
3      51 POLYGON ((147.6972 -42.6320...
4      70 POLYGON ((145.9652 -41.6320...
5      88 POLYGON ((144.2331 -40.6320...
6      89 POLYGON ((147.6972 -40.6320...
7     107 POLYGON ((142.5011 -39.6320...
8     108 POLYGON ((145.9652 -39.6320...
9     125 POLYGON ((140.769 -38.63203...
10    126 POLYGON ((144.2331 -38.6320...</code></pre>
</div>
</div>
<p>Next, we’ll work through steps 2 - 4. Let’s create a smaller hexagon within each original hex using <code>st_buffer()</code>, extract the coordinates of its vertices using <code>st_coordinates()</code>, and assign an integer to each vertex ranging from 1 to 7<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. We’ve created an anonymous function to pipe these steps together, and used <code>pmap()</code> to apply this function iteratively to every hexagon in the grid.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We use the <code>dist</code> argument in <code>st_buffer()</code> to define the size of the smaller hexagon, but this depends on the <code>cellsize</code> of the original larger hexagon (in the six-hexagon figure, <code>cellsize</code> = 2). Depending on the number of species you’d like to fit within each polygon and the shape of the polygon you’ve chosen, you may need to try out different values of <code>cellsize</code> and <code>dist</code> to find combinations that work best for your visualisation.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>vertex_coords <span class="ot">&lt;-</span> unique_hex <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">vertices =</span> <span class="fu">pmap</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">.l =</span> <span class="fu">list</span>(<span class="at">x =</span> hex_geometry),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="cf">function</span>(x) {</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">|&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_buffer</span>(<span class="at">dist =</span> <span class="sc">-</span><span class="fl">0.4</span>) <span class="sc">|&gt;</span>         <span class="co"># STEP 2: set size of smaller hex</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span>               <span class="co"># STEP 3: get vertex coordinates of smaller hex        </span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span>                    <span class="co"># convert matrix to tibble  </span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>)) <span class="sc">|&gt;</span> <span class="co"># convert tibble to simple features</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>L1, <span class="sc">-</span>L2) <span class="sc">|&gt;</span>               <span class="co"># remove unnecessary columns</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">vertex_position =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>)     <span class="co"># STEP 4: number vertices </span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    })) <span class="sc">|&gt;</span> </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> vertices)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vertex_coords, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 10 features and 2 fields
Active geometry column: hex_geometry
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 144.2331 ymin: -44.63203 xmax: 148.2746 ymax: -41.63203
Geodetic CRS:  WGS 84
# A tibble: 10 × 4
   hex_id                 hex_geometry             geometry vertex_position
    &lt;int&gt;                &lt;POLYGON [°]&gt;              &lt;POINT&gt;           &lt;int&gt;
 1     32 ((145.9652 -43.63203, 146.5… (146.4271 -43.63203)               1
 2     32 ((145.9652 -43.63203, 146.5… (146.7735 -43.03203)               2
 3     32 ((145.9652 -43.63203, 146.5… (147.4663 -43.03203)               3
 4     32 ((145.9652 -43.63203, 146.5… (147.8127 -43.63203)               4
 5     32 ((145.9652 -43.63203, 146.5… (147.4663 -44.23203)               5
 6     32 ((145.9652 -43.63203, 146.5… (146.7735 -44.23203)               6
 7     32 ((145.9652 -43.63203, 146.5… (146.4271 -43.63203)               7
 8     50 ((144.2331 -42.63203, 144.8…  (144.695 -42.63203)               1
 9     50 ((144.2331 -42.63203, 144.8… (145.0414 -42.03203)               2
10     50 ((144.2331 -42.63203, 144.8… (145.7342 -42.03203)               3</code></pre>
</div>
</div>
<p>In the resulting dataframe, the <code>hex_id</code> and <code>hex_geometry</code> columns contain the unique ID and geometry of the original large hexagons from the grid. Meanwhile, the remaining columns contain information for our newly created smaller hexagons: the <code>geometry</code> column contains the spatial coordinates of each hexagon’s respective corner vertex, and <code>vertex_position</code> identifies each vertex point.</p>
<p>We’d like to show information of 7 species in our hexagon, but despite having 7 points in <code>vertex_position</code>, the 7th point contains the same information as the 1st point. This is so that, when drawn by lines, the hexagon is closed. However, because we are only interested drawing points, we can mutate the duplicated row of the 7th vertex to hold the coordinates of the centroid of each hexagon instead. This will gives us seven distinct positions (step 5 in our six-hexagon figure).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>vertex_centroid_coords <span class="ot">&lt;-</span> vertex_coords <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">geometry =</span> <span class="fu">ifelse</span>(vertex_position <span class="sc">==</span> <span class="dv">7</span>,      </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">st_centroid</span>(hex_geometry), </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                           geometry)) <span class="sc">|&gt;</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span>                               </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vertex_centroid_coords, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 10 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 144.695 ymin: -44.23203 xmax: 147.8127 ymax: -42.03203
Geodetic CRS:  WGS 84
# A tibble: 10 × 3
   hex_id             geometry vertex_position
    &lt;int&gt;          &lt;POINT [°]&gt;           &lt;int&gt;
 1     32 (146.4271 -43.63203)               1
 2     32 (146.7735 -43.03203)               2
 3     32 (147.4663 -43.03203)               3
 4     32 (147.8127 -43.63203)               4
 5     32 (147.4663 -44.23203)               5
 6     32 (146.7735 -44.23203)               6
 7     32 (147.1199 -43.63027)               7
 8     50  (144.695 -42.63203)               1
 9     50 (145.0414 -42.03203)               2
10     50 (145.7342 -42.03203)               3</code></pre>
</div>
</div>
</section>
</section>
<section id="assign-species-to-positions" class="level2">
<h2 class="anchored" data-anchor-id="assign-species-to-positions">Assign species to positions</h2>
<p>The <code>melithreptus</code> dataframe (created earlier using <code>atlas_species()</code>) requires a small amount of tidying to be compatible with the rest of our data. The <code>species</code> column contains subgenera, which we can remove with regular expressions (regex)<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. We also need to ensure all species have a vernacular name, noting that <em>Melithreptus chloropsis</em> is currently lacking one in the ALA database. We can then assign a number (1-7) denoting each species’ position in a hexagon<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>species_data <span class="ot">&lt;-</span> melithreptus <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species, vernacular_name) <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">species =</span> <span class="fu">str_replace_all</span>(species, <span class="st">"</span><span class="sc">\\</span><span class="st">(.*?</span><span class="sc">\\</span><span class="st">)</span><span class="sc">\\</span><span class="st">s*"</span>, <span class="st">""</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">vernacular_name =</span> <span class="fu">if_else</span>(species <span class="sc">==</span> <span class="st">"Melithreptus chloropsis"</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Gilbert's Honeyeater"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                                   vernacular_name),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">vertex_position =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>species_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  species                    vernacular_name           vertex_position
  &lt;chr&gt;                      &lt;chr&gt;                               &lt;int&gt;
1 Melithreptus lunatus       White-naped Honeyeater                  1
2 Melithreptus brevirostris  Brown-headed Honeyeater                 2
3 Melithreptus albogularis   White-throated Honeyeater               3
4 Melithreptus gularis       Black-chinned Honeyeater                4
5 Melithreptus affinis       Black-headed Honeyeater                 5
6 Melithreptus validirostris Strong-billed Honeyeater                6
7 Melithreptus chloropsis    Gilbert's Honeyeater                    7</code></pre>
</div>
</div>
<p>Our final step is to bring these three dataframes (<code>hex_with_species</code>, <code>species_data</code>, <code>vertex_centroid_coords</code>) together with <code>dplyr::left_join()</code>.</p>
<p>We begin by joining our distinct hexagon and species combinations (<code>hex_with_species</code>) with our species positions and common names (<code>species_data</code>) using the <code>species</code> column…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>species_points_a <span class="ot">&lt;-</span> hex_with_species <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(hex_id, species) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(species_data,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(species))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(species_points_a, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   hex_id                    species          vernacular_name vertex_position
1      32 Melithreptus validirostris Strong-billed Honeyeater               6
2      32       Melithreptus affinis  Black-headed Honeyeater               5
3      50 Melithreptus validirostris Strong-billed Honeyeater               6
4      50       Melithreptus affinis  Black-headed Honeyeater               5
5      51 Melithreptus validirostris Strong-billed Honeyeater               6
6      51       Melithreptus affinis  Black-headed Honeyeater               5
7      70       Melithreptus affinis  Black-headed Honeyeater               5
8      70 Melithreptus validirostris Strong-billed Honeyeater               6
9      88 Melithreptus validirostris Strong-billed Honeyeater               6
10     88       Melithreptus affinis  Black-headed Honeyeater               5</code></pre>
</div>
</div>
<p>…and follow this with another join to get the point coordinates of each species’ point in each hexagon (<code>vertex_centroid_coords</code>), using the <code>vertex_position</code> and <code>hex_id</code> columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>species_points <span class="ot">&lt;-</span> species_points_a <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(vertex_centroid_coords,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(vertex_position, hex_id)) <span class="sc">|&gt;</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(species_points, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 10 features and 4 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 145.0414 ymin: -44.23203 xmax: 149.1983 ymax: -41.23203
Geodetic CRS:  WGS 84
   hex_id                    species          vernacular_name vertex_position
1      32 Melithreptus validirostris Strong-billed Honeyeater               6
2      32       Melithreptus affinis  Black-headed Honeyeater               5
3      50 Melithreptus validirostris Strong-billed Honeyeater               6
4      50       Melithreptus affinis  Black-headed Honeyeater               5
5      51 Melithreptus validirostris Strong-billed Honeyeater               6
6      51       Melithreptus affinis  Black-headed Honeyeater               5
7      70       Melithreptus affinis  Black-headed Honeyeater               5
8      70 Melithreptus validirostris Strong-billed Honeyeater               6
9      88 Melithreptus validirostris Strong-billed Honeyeater               6
10     88       Melithreptus affinis  Black-headed Honeyeater               5
                     geometry
1  POINT (146.7735 -44.23203)
2  POINT (147.4663 -44.23203)
3  POINT (145.0414 -43.23203)
4  POINT (145.7342 -43.23203)
5  POINT (148.5055 -43.23203)
6  POINT (149.1983 -43.23203)
7  POINT (147.4663 -42.23203)
8  POINT (146.7735 -42.23203)
9  POINT (145.0414 -41.23203)
10 POINT (145.7342 -41.23203)</code></pre>
</div>
</div>
</section>
<section id="map" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="map">Map</h2>
<p>Let’s check how our three spatial layers—basemap, hexagons, and species points—look on a map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ozmap_states, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> unique_hex, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> species_points, <span class="fu">aes</span>(<span class="at">colour =</span> vernacular_name)) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lims</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">112</span>, <span class="dv">155</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">46</span>, <span class="sc">-</span><span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="post_files/figure-html/unnamed-chunk-24-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="post_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>This all looks correct! Now to add some final flourishes to make our map more aesthetically pleasing, as well as more accessible with a colourblind friendly palette by <a href="https://personal.sron.nl/~pault/">Paul Tol</a>.</p>
<div class="cell page-columns page-full" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">font_add_google</span>(<span class="st">"Montserrat"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">showtext_auto</span>(<span class="at">enable =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>tol_muted <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#88CCEE"</span>, <span class="st">"#CC6677"</span>, <span class="st">"#DDCC77"</span>, <span class="st">"#117733"</span>, <span class="st">"#332288"</span>, <span class="st">"#AA4499"</span>, <span class="st">"#44AA99"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ozmap_states, </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">colour =</span> <span class="st">"#ababab"</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> unique_hex, </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">"#efefef55"</span>, <span class="at">colour =</span> <span class="st">"#777777"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> species_points, <span class="fu">aes</span>(<span class="at">colour =</span> vernacular_name), </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">2.3</span>) <span class="sc">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> tol_muted,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">"*Melithreptus* &amp;#0020; species"</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">4</span>))</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lims</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">112</span>, <span class="dv">155</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">46</span>, <span class="sc">-</span><span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_markdown</span>(<span class="at">family =</span> <span class="st">"Montserrat"</span>, <span class="at">size =</span> <span class="dv">24</span>),</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"Montserrat"</span>, <span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"in"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="post_files/figure-html/unnamed-chunk-25-1.png" class="lightbox page-columns page-full" data-description="Distribution

of

Honeyeater

species" data-gallery="final-plot"><img src="post_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page" style="margin-left:auto;margin-right:auto;" width="960"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>This visualisation is a novel way to show range overlaps and distributions of multiple species at once. A key strength is the consistency of the repeatable hex unit—the fixed positions and colours of the species points make it easy to follow patterns within or between species.</p>
<p>This is also a very flexible method: it’s easy to customise:</p>
<ol type="1">
<li>the size, shape (hexagons vs squares) and orientation of the polygons</li>
<li>the colours and orientations of points within the hexagons, and</li>
<li>the spatial scale of the base map</li>
</ol>
<p>Consider also that you do not necessarily need to use exactly seven different species/taxa—with a bit of creativity, it is possible to fit any number of points from 2-9 into a hexagon (2-7) or square symmetrically…</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="post_files/figure-html/unnamed-chunk-26-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="post_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<details>
<summary style="color: #E06E53;">
<p>Expand for session info</p>
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.3.2 (2023-10-31 ucrt)
 os       Windows 10 x64 (build 19045)
 system   x86_64, mingw32
 ui       RTerm
 language (EN)
 collate  English_Australia.utf8
 ctype    English_Australia.utf8
 tz       Australia/Sydney
 date     2024-01-25
 pandoc   3.1.1 @ C:/Program Files/RStudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package     * version date (UTC) lib source
 dplyr       * 1.1.4   2023-11-17 [1] CRAN (R 4.3.2)
 forcats     * 1.0.0   2023-01-29 [1] CRAN (R 4.3.2)
 galah       * 2.0.0   2023-12-11 [1] Github (AtlasOfLivingAustralia/galah-R@be472e8)
 ggplot2     * 3.4.4   2023-10-12 [1] CRAN (R 4.3.1)
 ggtext      * 0.1.2   2022-09-16 [1] CRAN (R 4.3.2)
 htmltools   * 0.5.7   2023-11-03 [1] CRAN (R 4.3.2)
 lubridate   * 1.9.3   2023-09-27 [1] CRAN (R 4.3.2)
 ozmaps      * 0.4.5   2021-08-03 [1] CRAN (R 4.3.2)
 patchwork   * 1.1.3   2023-08-14 [1] CRAN (R 4.3.1)
 purrr       * 1.0.2   2023-08-10 [1] CRAN (R 4.3.2)
 readr       * 2.1.4   2023-02-10 [1] CRAN (R 4.3.2)
 sessioninfo * 1.2.2   2021-12-06 [1] CRAN (R 4.3.2)
 sf          * 1.0-14  2023-07-11 [1] CRAN (R 4.3.2)
 showtext    * 0.9-6   2023-05-03 [1] CRAN (R 4.3.2)
 showtextdb  * 3.0     2020-06-04 [1] CRAN (R 4.3.2)
 stringr     * 1.5.1   2023-11-14 [1] CRAN (R 4.3.2)
 sysfonts    * 0.8.8   2022-03-13 [1] CRAN (R 4.3.2)
 tibble      * 3.2.1   2023-03-20 [1] CRAN (R 4.3.2)
 tidyr       * 1.3.0   2023-01-24 [1] CRAN (R 4.3.2)
 tidyverse   * 2.0.0   2023-02-22 [1] CRAN (R 4.3.2)

 [1] C:/Users/KEL329/R-packages
 [2] C:/Users/KEL329/AppData/Local/Programs/R/R-4.3.2/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
</details>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>There are over half a million records from this genus in the ALA, so restricting our download to records from 2022 significantly speeds things up!<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Using <code>distinct()</code> produces an identical result to <code>count()</code> here, but is far slower because checking for distinct values in the geometry column is computationally intensive. If your dataframe has fewer rows, you could also do this: <code>hex_with_species |&gt; select(hex_id, hex_geometry) |&gt; distinct()</code>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Each hexagon is formed as a closed (rather than open) polygon, whereby the vertices are joined in the following order: 1-2-3-4-5-6-1. So although there are only 6 vertices, we get 7 sets of coordinates, with the first and seventh sets being duplicated to close the polygon.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Regular expressions, or regex, are used to match specific patterns in strings. Here, we want to remove the inclusion of subgenera, parentheses, and any extra spaces in species names (e.g.&nbsp;<code>"Melithreptus (Melithreptus) affinis"</code> to <code>"Melithreptus  affinis"</code>), and we do this using <code>species = str_replace_all(species, "\\(.*?\\)\\s*", "")</code>. We’re looking for a sequence that starts with an opening parenthesis (<code>\\(</code>), is followed by any characters (<code>.*?</code>), and ends with a closing parenthesis (<code>\\)</code>). Any spaces following the closing parenthesis (<code>\\s*</code>) are also matched. Such sequences are replaced with an empty string (<code>""</code>), effectively removing them.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Here we assign the positions simply with <code>vertex_position = c(1:7)</code>, however you can reorder the dataframe or this position vector to have more control over which point in the hexagon each species is assigned. For instance, you might wish to do this to separate similar colours within the hexagon, or to assign the most widely distributed species to the centre point.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<!-- ALA Template Footer -->

<style>

/*-- Copyright --*/

.copyright-container {
  display: flex!important;
  width: 100%;
  margin-bottom: 30px;
  margin-top: 30px;
}

.copyright-row {
  width: 100%;

  position: relative;

  background-color: #c44d34;
  background-position: bottom;
  background-size: cover;
  display: flex;
}

.copyright-width {
  display: flex;
  width: 100%;
  max-width: 1140px;
  padding-left: 15px;
  padding-right: 15px;
  padding-bottom: 0px;
  margin: auto;
}

.copyright-column-left {
  float: left;
  width: 50%;
  max-width: 50%;
  padding-left: 15px;
  padding-right: 15px;
  position: relative;
  min-height: 1px;
  display: flex!important;
  flex-direction:column;
  display:inline-block;
}

.copyright-column-right {
  float: right;
  text-align: right;
  width: 50%;
  max-width: 50%;
  padding-left: 15px;
  padding-right: 15px;
  position: relative;
  min-height: 1px;
  display: flex!important;
  flex-direction: column;
  display:inline-block;
}

.copyright-text {
  color: white;
  font-size: 12px;
  padding-top: 10px}

.copyright-text a:hover {
  color: #222322;
}


/*-- Logos and acknowledgement --*/

.footer-container {
  display: flex!important;
  width: 100%;
  max-width: 1140px;
  padding-left: 15px;
  padding-right: 15px;
  padding-top: 50px;
  padding-bottom: 50px;
  margin: auto;
}

.distill-site-footer {
  padding-top: 0px;
  padding-bottom: 10px;
  text-align: left;
}

.row-footer { /* Do not change the name of this column - it causes issues */
    display: -ms-flexbox;
    display: flex;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
}

.column-footer { /* Do not change the name of this column - it causes issues */
  float: left;
  width: 50%;
  max-width: 50%;
  padding-left: 15px;
  padding-right: 15px;
  position: relative;
  min-height: 1px;
  display: flex;
  flex-direction:column;
  display:inline-block;
}


.footer-logo {
  text-align: left;
  margin:5px;
}

.footer-text {
  font-family: "Lato", sans-serif;
  font-weight: 700;
  font-size: 1.1rem;
  line-height: 1.2;
  color: #565656;
  text-align: left;
}

.footer-text-small {
  font-family: Roboto,sans-serif;
  font-size: .82rem;
  font-weight: 400;
  line-height: 1.5;
  font-family: "Roboto", sans-serif;
  font-weight: 400;
  color: #565656;
  text-align: left;
  margin-top: 10px;
}

/*-- Back to ALA button --*/

.link-container {
  margin-top: 30px;
  margin-bottom: 30px;
  display: block;
  width: 30em;
  margin-left: auto;
  margin-right: auto;
}

.link-button {
  border: none;
  color: #E06E53;
  padding: 10px 15px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 18px;
  margin: 4px 2px;
  transition-duration: 0.3s;
  cursor: pointer;
  background-color: white;
  border: 2px solid #E06E53;
  border-radius: 10px;
}

.link-button:hover {
  background-color: #222322;
  border: 2px solid #222322;
  color: #E06E53;
}

.ala-icon {
    height: 20px;
    width: auto;
    /* Other styles here */
}

@media screen and (max-width: 952px) {
  .link-container {
    margin: auto;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .footer-container {
    width: 100%;
    max-width: 100%;
    display: flex;
    flex-wrap: wrap;
  }
  .column-footer {
    float:left;
    width: 100%;
    max-width: 100%;
    display: block;
    margin-top: 20px;
  }
  .link-container {
    display: block;
    width: 20em;
    margin: auto;
  }

  .copyright-column-left {
    width: 50%;
  }

  .copyright-column-right {
    width: 50%;
  }

  .copyright-row {
    height: 100px;
    margin-bottom: -3.75vw;
  }
}

.logo-ncris {
  width: auto;
  height: 109px;
  margin-right: 15px;
  margin-top: 20px;
}

.logo-csiro {
  width: auto;
  height: 109px;
  margin-right: 15px;
  margin-top: 20px;
}

.logo-gbif {
  width: auto;
  height: 109px;
}

@media (min-width: 992px) {}
body .page-columns{
  grid-column: screen-start/screen-end;
  z-index: 998;
  transform: translate3d(0, 0, 0);
}
}

</style>

<hr style="padding-top: 1px">

<div class="footer-container column-screen page-columns page-full">

  <!--<div class = "row-footer">-->
    <div class="column-footer">
      <p class="footer-text">The ALA is made possible by contributions from its partners, is supported
      by
      <a href="https://www.education.gov.au/national-collaborative-research-infrastructure-strategy-ncris" class="footer-link">NCRIS</a>, is hosted by
             <a href="https://csiro.au/" class="footer-link">CSIRO</a>, and is the Australian node of
             <a href="https://www.gbif.org/en/" id="d-article" class="footer-link">GBIF</a>.
      </p>
      <a href="https://www.education.gov.au/national-collaborative-research-infrastructure-strategy-ncris">
        <img src="images/logos/NCRIS_logo.png" class="logo-ncris" alt="NCRIS logo">
        
        </a>
      <a href="https://csiro.au/">
        <img src="images/logos/CSIRO_logo.png" class="logo-csiro" alt="CSIRO logo">
        
        </a>
      <a href="https://www.gbif.org/en/">
        <img src="images/logos/GBIF_109px.png" class="logo-gbif" alt="GBIF logo">
        
        </a>
    </div>
    <div class="column-footer" id="footer-logo">
      <p class="footer-text"><strong>Acknowledgement of Traditional Owners and Country</strong></p>
      <p class="footer-text-small">The Atlas of Living Australia acknowledges Australia's Traditional Owners
      and pays respect to the past and present Elders of the nation's Aboriginal
      and Torres Strait Islander communities. We honour and celebrate the
      spiritual, cultural and customary connections of Traditional Owners to
      country and the biodiversity that forms part of that country.<br><br></p>
    </div>
<!--  </div>-->
</div>

<div class="copright-container column-screen">
  <div class="copyright-row">
     <div class="copyright-width">
  		<div class="copyright-column-left">
  				<p class="copyright-text">
  					This work is licensed under a <a style="color:#fff!important;" href="https://creativecommons.org/licenses/by/3.0/au/">Creative Commons Attribution 3.0 Australia License</a>
  					<a rel="license" href="http://creativecommons.org/licenses/by/3.0/au/"><img alt="Creative Commons License" style="border-width:0" src="images/logos/cc-by.png"></a>
  				</p>
			</div><!--col end -->
    	<div class="copyright-column-right">
         <p class="copyright-text">
           <a style="color:#fff!important;" href="https://www.ala.org.au/terms-of-use#cy">Copyright</a>
           &nbsp;&nbsp;
           <a style="color:#fff!important;" href="https://www.ala.org.au/terms-of-use">Terms of Use</a>
           &nbsp;&nbsp;
           <a style="color:#fff!important;" href="https://status.ala.org.au/">System Status</a>
         </p>
      </div>
    </div>
	</div><!-- row end -->
</div>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","openEffect":"zoom","selector":".lightbox","loop":false,"descPosition":"bottom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>
