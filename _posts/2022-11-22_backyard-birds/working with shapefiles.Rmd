---
title: "Extract the number of points within each polygon for choropleth maps"
description: |
  Choropleth maps are an excellent way to visualise numbers of observations in each region. When using point data, calculating the number of points in each polygon can be difficult when using shapefiles. Here we demonstrate how to extract and summarise the number of points in each polygon within a shapefile to create a choropleth map. 
author: 
  - name: "Olivia Torresan"
  - name: "Dax Kellie"
date: "2022-11-21"
categories:
  - Summaries
  - Maps
  - Eukaryota
  - Animalia
output: 
  distill::distill_article:
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 3
draft: true
---


<!------ Complete title, description, author and date for website metadata ------>

<!-- load html package & get date -->
```{r, include=FALSE}
library(htmltools)
date.func <- format(Sys.time(), '%d %B, %Y')
```

<!-- remove distill metadata section -->
```{css, echo = FALSE}
d-byline {
    display: none;
  }
```

<!-- Author card -->

:::author-card
:::float-image

<!-- Author image --> 
```{r, out.width='120px', out.extra='style="float:right; margin-left:15px; margin-right:50px; clip-path: circle();"', echo=FALSE}
# add author first name at the end of this url (e.g., ".../people/martin.jpg")
knitr::include_graphics(c("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/dax.jpg", "https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/olivia.jpg"))
```

:::author-card-text
<!-- Author name -->
<h4 style = "margin-bottom:5px">Author:</h4>
[Olivia Torresan](https://labs.ala.org.au/people/Torresan_Olivia/index.html)
[Dax Kellie](https://labs.ala.org.au/people/Kellie_Dax/index.html)

<!-- Date -->
<h4 style = "margin-bottom:5px">Date:</h4>
20 November, 2022
:::

:::
:::

<br>



<!------ Post content starts here ------>
Choropleth maps are an excellent way to visualise differences of a variable (eg. number of species observed) across several geographic regions (eg. countries, states, study areas). Often, creating a choropleth map requires that you find and download a shapefile, or a file with vector data of a specific geographic location with detailed information of its geographic features. 

Species observations are recorded as point data - the specific longitude and latitude coordinates of where an individual was observed. However, to create a choropleth map that summarises our species observations will require us to summarise our points to a single statistic for each polygon of a shapefile. This conversion from points to polygons can sometimes be tricky.

Here, we show you how to extract and count the number of points inside each polygon of a shapefile to create a choropleth map of the total number of species observations in each suburb of the Australian Capital Territory (ACT). 

## Download data

First we will load the R packages that we need: 


```{r}
library(feathers)
library(galah) 
library(ggnewscale) 
library(here) 
library(purrr) 
library(rmapshaper) 
library(sf) 
library(tidyverse) 
```


### Download shapefile

Next we will need a shapefile. You can find many shapefiles online from reputable sources. For this example, I've retrieved a shapefile of suburb boundaries in the city of Canberra, ACT from an [open-access state government source](https://www.actmapi.act.gov.au/download.html). 

Usually when you download a shapefile, they are compressed inside of a zip folder. Save this downloaded zip folder in a local folder inside your current [R project](https://r4ds.had.co.nz/workflow-projects.html). If you wish to unzip your folder, you can do so with the following code: 

```{r, eval = FALSE}
zip_folder <- here::("folder", "act_localities-folder.zip") 
output_dir <- "name-of-folder-to-save-unzipped-files" 
unzip(zip_filder, exdir = output_dir) 
```

Now we load this unzipped shapefile into R. To save space, we'll remove some complexity from out shapefile polygons with `ms_simplify()` from the {rmapshaper} package.

```{r, eval = FALSE}
actsuburbs <- st_read(here("folder",
                           "act_localities_unzipped",
                           "act_localities.shp"),
                      quiet = TRUE) |>
  ms_simplify(keep = 0.1)
```


```{r, echo = FALSE}
actsuburbs <- st_read(here("_posts", 
                           "2022-11-22_backyard-birds",
                           "data", 
                           "act_localitiesunzip", 
                           "act_localities.shp"), 
                     quiet = TRUE) |> 
  ms_simplify(keep = 0.1) 
```


The `actsuburbs` shapefile contains both suburb boundaries and district boundaries. Districts can encompass several suburbs, and so to avoid confusion we will remove the districts because we are only interested in suburbs. 

```{r}
actsuburbsonly <- subset(actsuburbs, LOC_CLASS != "District") 
```

Now let's prepare our shapefile. First we will set the spatial projection of our shapefile to be consistent with that of the ALA - `"WGS84"` - to ensure our map matches the spatial projection of our data. We'll also use `st_make_valid()` to make sure any weird invalid geometries in our shapefile are made valid, and therefore plot correctly.

```{r}
actsuburbs <- actsuburbsonly |> 
  st_transform(crs = st_crs("WGS84")) |> 
  st_make_valid() 
```

Now to see if our shapefile plots correctly, we can use `geom_sf()` (and it looks like it does!)

```{r}
ggplot() +
  geom_sf(data = actsuburbs)
```


### Download species observations

Now let's use `galah` to download bird occurrence records from the [Atlas of Living Australia (ALA)](https://www.ala.org.au/). You will need to first enter a [registered email with the ALA](https://auth.ala.org.au/userdetails/registration/createAccount) using `galah_config()` before fetching records.

```{r}
galah_config(email = "oliviajane.t@hotmail.com", verbose = FALSE) 
```


Here, we'll download all *Aves* data provided by BirdLife Australia in each suburb. To only download records within the ACT, we can also use `galah_filter()` to narrow our download to only records within the longitude and latitude of the ACT.

```{r}
birdocc <- galah_call() |> 
  galah_identify("Aves") |> 
  galah_filter(profile = "ALA", 
               decimalLongitude > 148.0 & decimalLongitude < 150, 
               decimalLatitude < -35.0 & decimalLongitude > -36,
               dataProviderName == "BirdLife Australia") |>  
  atlas_occurrences() 
```



## Prepare data to merge with shapefile 

To prepare our data to categorise which points are in which polygons, we'll first split up our observations for counting. To do this, we'll split our data into separate `data.frame`s by row (because each row corresponds to one observation) and "store" the latitude and longitude values as spatial point coordinates with `st_point()`.

```{r}
allbirdpoints <- birdocc %>% 
  split(1:nrow(.)) %>% 
  map(~ st_point(c(as.numeric(.x['decimalLongitude']), 
                   as.numeric(.x['decimalLatitude']))))
```

Next we will transform the occurrence points to spatial objects using `st_as_sfc()` and ensure their projection is consistent with our shapefile with `st_set_crs("WGS84")`. 


```{r}
points_geomall <- allbirdpoints |> st_as_sfc() |> st_set_crs("WGS84") 
```


Now we'll find which points are in each of our suburbs using `st_intersects()`. This function checks whether each point is within, or "intersects", a specified `POLYGON` and then marks it as `TRUE` or `FALSE` in a matrix. In our case, we'll mark the points that intersect with each suburb.

```{r}
intersect <- st_intersects(points_geomall, actsuburbs) 
```


## Summarise counts

With our points categorised, we can now use this to count the number of points in each suburb polygon.

Our `intersect` object has matched each point to a suburb number (analogous to row number). So it is possible to group by suburb and count the number of points if we "flatten" our data back from a `list` to a `data.frame` or a `tibble`. Here's the first 10 rows of `intersect` as a `tibble`, and we can see all of those points are in polygon 108 (referring to the polygon in row 108 of `actsuburbs`).

```{r}
intersect |>
  flatten_int() |> 
  as_tibble() |>
  head(10L)
```


To count our points, we can group by suburb number, and summarise the count of records using `n()`.

```{r}
points_in_polygons <- intersect |>
  flatten_int() |> 
  as_tibble() |> # to see individual values, run code to here
  group_by(value) |> 
  summarise(count = n())

points_in_polygons |> head(8L)
```


## Join summary data to polygons

Before making our map, there are a few final steps that we need to do to clean up our data.

First, we need to join the `points_in_polygons` data with the shapefile `actsuburbs`. Because each suburb ID number (`value`) was assigned based on the row number of each suburb polygon in `actsuburbs`, we can match these IDs back to our polygons by creating a column containing the suburb `row_number`! 

```{r}
actsuburbs <- actsuburbs |>
  mutate(region_id = row_number()) 

actsuburbs |> head(5L)
```

Now we can use `full_join()` to merge `points_in_polygons` to `actsuburbs`, specifying that the `value` column is equal to the `region_id` column we just made. We also replace any `NA` values with 0s using `replace_na()` and convert to a spatial object with `st_as_sf()`. Doing this means our map will actually produce a representative color in regions without any records.

```{r}
counts_map <- points_in_polygons |>
  full_join(actsuburbs, by = c("value" = "region_id")) |> 
  tidyr::replace_na(list(count = 0)) |> 
  st_as_sf() 

counts_map |> head(5L)
```

<aside>

In the spirit of `galah`, we created a galah palette inspired by the [{feathers} package](https://github.com/shandiya/feathers), a package of colour palettes from female bird plumage by [Shandiya Balasubramaniam](https://labs.ala.org.au/people/Balasubramaniam_Shandiya/index.html)

```{r, echo = FALSE}
galah <- colorRampPalette(c("#FFD2CF", 
                            "#EC9FAC", 
                            "#D96D89", 
                            "#B55474", 
                            "#80556D"))(5) 
print_pal(galah) 
```

</aside>

# Map data

Our count data is skewed because many regions have lower numbers of observations and only a few regions have very high numbers of observations. Log transformation will reduce the skew in our data, ultimately making our final choropleth map easier to interpret. 

```{r}
hist(counts_map$count)
```

First, let's add log-transformed counts to a new `log_counts` column. Next we'll add a column called `counts_discrete` which uses `cut()` to assign a number from 0 to 5 depending on what range each `log_counts` number falls within (0-1, 1-2, 2-3, 3-4 or 4-5). To make this easier to interpret, we have also added labels that correspond to the normal count values (0, 10, 100, 1000, 10000). Finally, we'll make sure any `NA` values are converted to 0.

```{r}
counts_map <- counts_map |>
  rowwise() |> 
  mutate(log_counts = log10(count)) |>
  mutate(counts_discrete = cut(log_counts, 
                               breaks = c(0, 1, 2, 3, 4, 5), 
                               labels = c(0, 10, 100, 1000, 10000),
                               include.lowest = TRUE)) |> 
  replace_na(list(counts_discrete = "0")) 

counts_map |> head(5L)
```

Now we can use `ggplot2` to make our choropleth map!

```{r, layout="l-page"}
ggplot() +
  geom_sf(
    data = counts_map,
    mapping = aes(fill = counts_discrete), 
    colour = "NA" 
  ) +
  geom_sf() +
  scale_fill_manual(
    name = "Number of observations*", 
    drop = FALSE,
    labels = c("10", "100", "1,000", "10,000"), 
    values = galah, 
    guide = guide_colorsteps( 
      direction = "vertical", 
      label.position = "right",
      title.position = "top"
    )
  ) +
  labs( 
    title = "Bird Records by Suburb",
    subtitle = "Canberra (ACT)",
    caption = "*ALA BirdLife Australia data"
  ) + 
  theme_void()
```



# Final thoughts

There's not much better than a galah-themed choropleth map!

One way you can extend this map is to add floating labels with `geom_text_repel()` or `geom_label_repel()` from the [{ggrepel} package](https://ggrepel.slowkow.com/index.html), which we added for our [final version of our map we posted for National Bird Week 2022](https://twitter.com/atlaslivingaust/status/1582495493308829696). Code to add floating labels can be found [here](https://github.com/AtlasOfLivingAustralia/science/blob/main/comms/2022-10-19_backyard-birds-map/backyard%20birds.Rmd).

You can also [learn how to create a choropleth map with two different colour scales in this ALA Labs post](https://labs.ala.org.au/posts/2022-05-23-ggnewscale/)!






