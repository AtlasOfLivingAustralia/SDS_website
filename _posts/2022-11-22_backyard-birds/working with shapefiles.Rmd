---
title: "Creating spatial data points and using shapefiles with {galah}"
description: |
  Shapefiles are frequently used to visualise spatial data. 
  While the `galah` package has some inbuilt [fields](http://galah.ala.org.au/articles/narrow_your_results.html#galah_filter) 
  that you can use to spatially summarise data, it may not have what you 
  require. Here, we will show you how to use your own shapefile with data from 
  the ALA using the {galah} package. 
author: 
  - name: "Dax Kellie"
  - name: "Olivia Torresan"
date: "2022-11-21"
categories:
  - Summaries
  - Maps
  - Eukaryota
  - Animalia
output: 
  distill::distill_article:
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 3
draft: true
---







<!------ Complete title, description, author and date for website metadata ------>

<!-- load html package & get date -->
```{r, include=FALSE}
library(htmltools)
date.func <- format(Sys.time(), '%d %B, %Y')
```

<!-- remove distill metadata section -->
```{css, echo = FALSE}
d-byline {
    display: none;
  }
```

<!-- Author card -->

:::author-card
:::float-image

<!-- Author image --> 
```{r, out.width='120px', out.extra='style="float:right; margin-left:15px; margin-right:50px; clip-path: circle();"', echo=FALSE}
# add author first name at the end of this url (e.g., ".../people/martin.jpg")
knitr::include_graphics(c("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/dax.jpg", "https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/olivia.jpg"))
```

:::author-card-text
<!-- Author name -->
<h4 style = "margin-bottom:5px">Author:</h4>
[Dax Kellie](https://labs.ala.org.au/people/Kellie_Dax/index.html)
[Olivia Torresan](https://labs.ala.org.au/people/Torresan_Olivia/index.html)

<!-- Date -->
<h4 style = "margin-bottom:5px">Date:</h4>
20 November, 2022
:::

:::
:::

<br>



<!------ Post content starts here ------>

In some data visualizations, it might be worthwhile making use of an external shapefile when using the {galah} package. 

A shapefile is a data format that allows you to delineate specific geographical bounds on a map. `galah` has some fields that you can use to display data on a map (e.g. electoral regions) - but you may have a specific purpose in mind with bounds that are not available.

Here, we will show you how to work with external shapefiles and convert ALA data to points from `galah`, using many prominent packages within the `tidyverse` (e.g. `ggplot2`). 


First we will load the R packages that we need: 


```{r}
library(feathers)
library(galah) 
library(ggnewscale) 
library(here) 
library(purrr) 
library(rmapshaper) 
library(sf) 
library(tidyverse) 
```


## Download shapefile of interest

You can find many shapefiles online from reputable sources. For this example, I've retrieved a shapefile of suburb boundaries in the city of Canberra, Australian Capital Territory (ACT) (act_localities) from an [open-access state government source](https://www.actmapi.act.gov.au/download.html). 

If your downloaded file is zipped and it needs to be unzipped - you can do so here. Sometimes R responds better to the file if it is unzipped internally. 

****************************

```{r, eval = FALSE}
zipF <- here::("folder", "act_localities-file.zip") 
outDir <- "name-of-folder-to-save-unzipped-files" 
unzip(zipF, exdir = outDir) 
```

This chunk of code will load the shapefile into your R environment. 

```{r}
actsuburbs <- st_read(here("_posts", 
                           "2022-11-22_backyard-birds",
                           "data", 
                           "act_localitiesunzip", 
                          "act_localities.shp"), 
                     quiet = TRUE) |> 
  ms_simplify(keep = 0.1) 
```


The actsuburbs shapefile countains both suburb boundaries and larger, encompassing "district" boundaries (see actsuburbs in environment). There are overlaps in these names, so to avoid confusion we will remove the districts as we are only interested in suburbs. 

```{r}
actsuburbsonly <- subset(actsuburbs, LOC_CLASS != "District") 
```

Seeing if the shapefile works before proceeding is good practice. Here, we also set its spatial projection to be consistent with that of `galah` - WGS84 - so it lines up accurately with the rest of our data.

```{r}
actsuburbs <- actsuburbsonly |> 
  st_transform(crs = st_crs("WGS84")) |> 
  st_make_valid() 
```

You can then plot your shapefile in ggplot2.

```{r}
ggplot() + 
  geom_sf(data = actsuburbs) + 
   theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size= 6))
```

Now let's use `galah` to download occurrence records from the [Atlas of Living Australia (ALA)](https://www.ala.org.au/). Note that you will need to first enter a [registered email with the ALA](https://auth.ala.org.au/userdetails/registration/createAccount) using `galah_config` before fetching records.

```{r}
galah_config(email = "oliviajane.t@hotmail.com", verbose = FALSE) 
```


Here, we use the example of bird data ("Aves") provided by BirdLife Australia in each suburb. I've also restricted the search to the decimal longitude and latitude within the ACT region to improve the download speed.

```{r}
birdocc <- galah_call() |> 
  galah_identify("Aves") |> 
  galah_filter(profile = "ALA", 
               decimalLongitude > 148.0 & decimalLongitude < 150, 
               decimalLatitude < -35.0 & decimalLongitude > -36,
              dataProviderName == "BirdLife Australia") |>  
  atlas_occurrences() 
```

## Prepare 'galah' data to merge with shapefile 

This prepares our data to be recognized as points on a map. It takes each row (`1:nrow(.)`) (our points) and "stores" them as latitude and longitude values.

```{r}
allbirdpoints <- birdocc %>% 
  split(1:nrow(.)) %>% 
  map(~ st_point(c(as.numeric(.x['decimalLongitude']), 
                   as.numeric(.x['decimalLatitude']))))
```

Now we will transform the occurrence points to spatial objects using the `sf` package so they can be plotted (`st_as_sfc`), and ensure their projection is consistent with our shapefile and 'galah' data (`st_set_crs`) (WGS84). 


```{r}
points_geomall <- allbirdpoints |> st_as_sfc() |> st_set_crs("WGS84") 
```


Now, we need to intersect the points we have created with our shapefile of interest using the `sf` package.


```{r}
intersect <- st_intersects(points_geomall, actsuburbs) 
```


## Count summary - suburb bird count

Given the bird data and the shapefile are intersected, we can figure out a summary bird count value for each suburb polygon.

Each point is allocated with a suburb ID number (e.g. row 121 = the suburb of Yarralumla). There are 545 "121" values, meaning 545 records in Yarralumla. 

To do this, we need to ['unlist'] (https://purrr.tidyverse.org/reference/flatten.html) the list object we just named "intersect" (as in this state, it cannot be worked with). A list object can be understood as 3D vs 2D - it comprises many data frames within itself (which can be helpful sometimes). We want this to all be in one data frame, though, therefore, we "flatten" it into one. "int" means we are converting the values into integer form.


```{r}
points_in_polygons <- intersect |>
  flatten_int() |> 
  as_tibble() |> 
  group_by(value) |> 
  summarise(count = n()) 
```


## Join count data to each suburb polygon

In order to join the count data to each suburb polygon, there are a few things that we need to clean up. Firstly, we need to create a column in the shapefile (actsuburbs) representing the row number, as this will be our suburb or region ID that will then match up with the count values (from the last step). These count values are named "value", but I've renamed it to ID as this is a bit misleading (`rename(id = value)`). We also replace any not available (na) numbers with 0. Doing this means our map will actually produce a representative color in the NA regions. Lastly, save as a spatial object (sf) ready to be mapped with ggplot2. 

```{r}
actsuburbs <- actsuburbs |>
  mutate(region_id = row_number()) 

counts_map <- points_in_polygons |>
  rename(id = value) |> 
  full_join(actsuburbs, by = c("id" = "region_id")) |> 
  tidyr::replace_na(list(count = 0)) |> 
  st_as_sf() 
```

<aside>

In spirit of  `galah` , we created a palette inspired by galah plumage in ['feathers'](https://github.com/shandiya/feathers), a palette package by [Shandiya Balasubramaniam](https://labs.ala.org.au/people/Balasubramaniam_Shandiya/index.html)

```{r, echo = FALSE}
galah <- colorRampPalette(c("#FFD2CF", 
                            "#EC9FAC", 
                            "#D96D89", 
                            "#B55474", 
                            "#80556D"))(5) 
print_pal(galah) 
```

</aside>

## Log10 transform  data 
This will make the colors on the map  easier to interpret against one another. The range of the log10 data (0-1, 1-2, 2-3, 3-4, 4-5, 5>) are then allocated to sections that represent its true values (0-9, 10-99, 100-999, 1,000- 9,000, 10,000>). Any values that are NA are replaced with 0 so that the map can actually produce a representative color in the NA regions, as noted earlier. 


```{r}
counts_map <- counts_map |>
  rowwise() |> 
  mutate(log_counts = log10(count)) |>
  mutate(counts_discrete = cut(log_counts, 
                               breaks = c(0, 1, 2, 3, 4, 5), 
                               labels = c(0, 10, 100, 1000, 10000),
                               include.lowest = TRUE)) |> 
  replace_na(list(counts_discrete = "0")) 
```


`ggplot2` is used in `tidyverse`to plot the log10 transformed data, and our labels are marked to represent the true values.

```{r}
ggplot() +
  geom_sf(
    data = counts_map,
    mapping = aes(fill = counts_discrete), 
    colour = "NA" 
  ) +
  geom_sf() +
  scale_fill_manual(
    name = "Number of observations*", 
    drop = FALSE,
    labels = c("10", "100", "1,000", "10,000"), 
    values = galah, 
    guide = guide_colorsteps( 
      direction = "vertical", 
      label.position = "right",
      title.position = "top"
    )
  ) +
  labs( 
    title = "Bird Records by Suburb",
    subtitle = "Canberra (ACT)",
    caption = "*ALA BirdLife Australia data",
    y = "y", x ="x"
  ) + 
  theme_void()
```


















