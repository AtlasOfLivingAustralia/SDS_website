---
title: "Extract the number of points within each polygon for choropleth maps"
description: |
  Choropleth maps are an excellent way to visualise numbers of observations in each region. When using point data, calculating the number of points in each polygon can be difficult when using shapefiles. Here we demonstrate how to extract and summarise the number of points in each polygon within a shapefile to create a choropleth map. 
author: 
  - name: "Olivia Torresan"
  - name: "Dax Kellie"
date: "2022-11-21"
categories:
  - Summaries
  - Maps
  - Eukaryota
  - Animalia
output: 
  distill::distill_article:
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 3
draft: true
---


<!------ Complete title, description, author and date for website metadata ------>

<!-- load html package & get date -->
```{r, include=FALSE}
library(htmltools)
date.func <- format(Sys.time(), '%d %B, %Y')
```

<!-- remove distill metadata section -->
```{css, echo = FALSE}
d-byline {
    display: none;
  }
```

<!-- Author card -->

:::author-card
:::float-image

<!-- Author image --> 
```{r, out.width='120px', out.extra='style="float:right; margin-left:15px; margin-right:50px; clip-path: circle();"', echo=FALSE}
# add author first name at the end of this url (e.g., ".../people/martin.jpg")
knitr::include_graphics(c("https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/dax.jpg", "https://raw.githubusercontent.com/AtlasOfLivingAustralia/ala-labs/main/images/people/olivia.jpg"))
```

:::author-card-text
<!-- Author name -->
<h4 style = "margin-bottom:5px">Author:</h4>
[Olivia Torresan](https://labs.ala.org.au/people/Torresan_Olivia/index.html)
[Dax Kellie](https://labs.ala.org.au/people/Kellie_Dax/index.html)

<!-- Date -->
<h4 style = "margin-bottom:5px">Date:</h4>
20 November, 2022
:::

:::
:::

<br>



<!------ Post content starts here ------>
While the `galah` package has some inbuilt [fields](http://galah.ala.org.au/articles/narrow_your_results.html#galah_filter)

Choropleth maps are an excellent way to visualise differences of a variable across a geographic region, such as the number of species in each region. Often, creating a choropleth map requires that you find and download a shapefile specific to your area of interest, or a file with vector data of a specific geographic location with detailed information of its geographic features. 

Species observations, however, are recorded as point data, or the specific longitude and latitude coordinates of where an individual was observed. To create a choropleth map that summarises our species observations will require us to convert information from points to a summary statistic for each polygon of a shapefile. This conversion from points to polygons can sometimes be tricky.

Here, we will show you how to extract the number of individual points of species observations inside each polygon of a downloaded shapefile to create a choropleth map. 

## Download data

First we will load the R packages that we need: 


```{r}
library(feathers)
library(galah) 
library(ggnewscale) 
library(here) 
library(purrr) 
library(rmapshaper) 
library(sf) 
library(tidyverse) 
```


### Download shapefile

You can find many shapefiles online from reputable sources. For this example, I've retrieved a shapefile of suburb boundaries in the city of Canberra, Australian Capital Territory (ACT) (act_localities) from an [open-access state government source](https://www.actmapi.act.gov.au/download.html). 

Save your downloaded file in a local folder. If your downloaded file is zipped and it needs to be unzipped, you can unzip it with the following code: 

```{r, eval = FALSE}
zipF <- here::("folder", "act_localities-file.zip") 
outDir <- "name-of-folder-to-save-unzipped-files" 
unzip(zipF, exdir = outDir) 
```

Now you can load your unzipped shapefile into R. To save space, we'll simplify our polygon with `ms_simplify()` from the {rmapshaper} package, removing some complexity from our shapefile.

```{r, eval = FALSE}
actsuburbs <- st_read(here("folder",
                           "act_localities_unzipped",
                           "act_localities.shp"),
                      quiet = TRUE) |>
  ms_simplify(keep = 0.1)
```


```{r, echo = FALSE}
actsuburbs <- st_read(here("_posts", 
                           "2022-11-22_backyard-birds",
                           "data", 
                           "act_localitiesunzip", 
                           "act_localities.shp"), 
                     quiet = TRUE) |> 
  ms_simplify(keep = 0.1) 
```


The `actsuburbs` shapefile contains both suburb boundaries and district boundaries. Districts can encompass several suburbs, and so to avoid confusion we will remove the districts as we are only interested in suburbs. 

```{r}
actsuburbsonly <- subset(actsuburbs, LOC_CLASS != "District") 
```

Now let's prepare our shapefile. First we will set the spatial projection of our shapefile to be consistent with that of the ALA - WGS84 - to ensure our map uses the correct coordinates for our data. We'll also use `st_make_valid()` to make sure any weird invalid geometries in our shapefile are made valid, and therefore plot correctly.

```{r}
actsuburbs <- actsuburbsonly |> 
  st_transform(crs = st_crs("WGS84")) |> 
  st_make_valid() 
```

And now to see our shapefile we'll use `geom_sf()`, with a few extra theme adjustments to make it look nice.

```{r}
ggplot() +
  geom_sf(data = actsuburbs) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.text.x = element_text(size = 6),
    axis.text.y = element_text(size = 6)
  )
```


### Download species observations

Now let's use `galah` to download bird occurrence records from the [Atlas of Living Australia (ALA)](https://www.ala.org.au/). You will need to first enter a [registered email with the ALA](https://auth.ala.org.au/userdetails/registration/createAccount) using `galah_config()` before fetching records.

```{r}
galah_config(email = "oliviajane.t@hotmail.com", verbose = FALSE) 
```


Here, we download all *Aves* data provided by BirdLife Australia in each suburb. I've also used `galah_filter()` to narrow our download to only records within the longitude and latitude of the ACT region.

```{r}
birdocc <- galah_call() |> 
  galah_identify("Aves") |> 
  galah_filter(profile = "ALA", 
               decimalLongitude > 148.0 & decimalLongitude < 150, 
               decimalLatitude < -35.0 & decimalLongitude > -36,
               dataProviderName == "BirdLife Australia") |>  
  atlas_occurrences() 
```



## Prepare data to merge with shapefile 

This prepares our data to be recognized as points on a map. It takes each row (`1:nrow(.)`) (our points) and "stores" them as latitude and longitude values.

```{r}
allbirdpoints <- birdocc %>% 
  split(1:nrow(.)) %>% 
  map(~ st_point(c(as.numeric(.x['decimalLongitude']), 
                   as.numeric(.x['decimalLatitude']))))
```

Now we will transform the occurrence points to spatial objects using the `sf` package so they can be plotted (`st_as_sfc`), and ensure their projection is consistent with our shapefile and 'galah' data (`st_set_crs`) (WGS84). 


```{r}
points_geomall <- allbirdpoints |> st_as_sfc() |> st_set_crs("WGS84") 
```


Now we'll find which points are in each of our suburbs using `st_intersects()`. This function checks whether each point is within, or "intersects", a specified `POLYGON` and then marks it as `TRUE` or `FALSE` in a matrix. In our case, we'll mark the points that intersect with each suburb.

```{r}
intersect <- st_intersects(points_geomall, actsuburbs) 
```


## Summarise counts

Now the bird occurrence data and the shapefile are intersected, we can figure out a summary count value for each suburb polygon.

Our `intersect` object has matched each point to a suburb - but has returned this information in a "list" format. To summarise our counts, it's easiest to convert this information back to a `tibble`. So, we "flatten" our `intersect` object from a list to a vector of integers using `flatten_int()`, save them as a tibble, group by each suburb, and summarise the count of records using `n()`.

The way this works is that each point is allocated with a suburb ID number (`value`) (analogous to row number) depending on where it falls (e.g. row 121 = the suburb of Yarralumla ). There are 545 individual "121" values, meaning 545 records in Yarralumla. We will summarise these in the next step.


```{r}
points_in_polygons <- intersect |>
  flatten_int() |> 
  as_tibble() |> #to see individual values, run code to here
  group_by(value) |> 
  summarise(count = n())

points_in_polygons |> head(5L)
```


## Join summary data to polygons

In order to present summary count data for each suburb polygon, there are a few things that we need to clean up.

Firstly,  we need to join the `points_in_polygons` data with the shapefile `actsuburbs`. To do this, we create a column (using `mutate`) in (`actsuburbs`) representing row numbers. Row number is analogous to our suburb or region ID from the last step in `points in polygons`). 

Suburb ID numbers that produce our count are named `value` in the points_in_polygons `tibble`, but here, I renamed them to `id` for clarity.

We also replace any not available (na) numbers with 0. Doing this means our map will actually produce a representative color in regions without any records. 

Lastly, save as a spatial object (sf) ready to be mapped with ggplot2. 

```{r}
actsuburbs <- actsuburbs |>
  mutate(region_id = row_number()) 

counts_map <- points_in_polygons |>
  rename(id = value) |> 
  full_join(actsuburbs, by = c("id" = "region_id")) |> 
  tidyr::replace_na(list(count = 0)) |> 
  st_as_sf() 
```

<aside>

In spirit of  `galah` , we created a palette inspired by galah plumage in ['feathers'](https://github.com/shandiya/feathers), a palette package by [Shandiya Balasubramaniam](https://labs.ala.org.au/people/Balasubramaniam_Shandiya/index.html)

```{r, echo = FALSE}
galah <- colorRampPalette(c("#FFD2CF", 
                            "#EC9FAC", 
                            "#D96D89", 
                            "#B55474", 
                            "#80556D"))(5) 
print_pal(galah) 
```

</aside>

# Map data

Log transformation will reduce the skew in our data (histogram below), making the colours of our representative scale easier to interpret (as incremental gaps between numbers are balanced within a smaller range, and each group is allocated a distinct color). 
```{r}
hist(counts_map$count)
hist(counts_map$count)
```

The range of the log10 data (here, 0-1, 1-2, 2-3, 3-4, 4-5, 5>) are labelled against sections that represent its true values (0-9, 10-99, 100-999, 1,000- 9,000, 10,000>). Any values that are NA are replaced with 0 so that the map can actually produce a representative color in the NA regions, as noted earlier. 


```{r}
counts_map <- counts_map |>
  rowwise() |> 
  mutate(log_counts = log10(count)) |>
  mutate(counts_discrete = cut(log_counts, 
                               breaks = c(0, 1, 2, 3, 4, 5), 
                               labels = c(0, 10, 100, 1000, 10000),
                               include.lowest = TRUE)) |> 
  replace_na(list(counts_discrete = "0")) 
```


`ggplot2` is used in `tidyverse`to plot the log10 transformed data, and our labels are marked to represent their true values.

```{r, layout="l-body-outset"}
ggplot() +
  geom_sf(
    data = counts_map,
    mapping = aes(fill = counts_discrete), 
    colour = "NA" 
  ) +
  geom_sf() +
  scale_fill_manual(
    name = "Number of observations*", 
    drop = FALSE,
    labels = c("10", "100", "1,000", "10,000"), 
    values = galah, 
    guide = guide_colorsteps( 
      direction = "vertical", 
      label.position = "right",
      title.position = "top"
    )
  ) +
  labs( 
    title = "Bird Records by Suburb",
    subtitle = "Canberra (ACT)",
    caption = "*ALA BirdLife Australia data",
    y = "y", x ="x"
  ) + 
  theme_void()
```



# Final thoughts

And here's the final map!

You can also manually create polygons and query the ALA for records within each polygon using [`galah_geolocate`] (http://galah.ala.org.au/articles/narrow_your_results.html#galah_geolocate). This is helpful sometimes, but here - creates more work than is necessary.

Adding labels to the map using `geom_text_repel` or `geom_label_repel` in the [`ggrepel`] (https://ggrepel.slowkow.com/index.html) package is also an option.


If you want to see how to create a similar chloropleth map without a shapefile using `galah`'s inbuilt fields, you can find a helpful blog post by [Shandiya](https://labs.ala.org.au/people/Balasubramaniam_Shandiya/index.html) using this [link](https://labs.ala.org.au/posts/2022-05-23-ggnewscale/). 






